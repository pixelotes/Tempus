<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Tempus{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <style>
        body {
            padding-top: 60px;
            background-color: #f8f9fa;
        }

        .sidebar {
            position: fixed;
            top: 56px;
            left: 0;
            bottom: 0;
            width: 250px;
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar a {
            color: #adb5bd;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
            transition: all 0.3s;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background-color: #495057;
            color: #fff;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                top: 0;
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="bi bi-clock-history"></i> Tempus
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ current_user.nombre }}
                            <span class="badge bg-secondary">{{ current_user.rol }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('main.perfil') }}">
                                    <i class="bi bi-key"></i> Cambiar contraseña
                                </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                                </a></li>
                        </ul>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    {% if current_user.is_authenticated %}
    <div class="sidebar">
        <a href="{{ url_for('main.index') }}" {% if request.endpoint=='main.index' %}class="active" {% endif %}>
            <i class="bi bi-house-door"></i> Inicio
        </a>

        <div class="text px-3 mt-3 mb-2 small" style="color: white;">PRINCIPAL</div>
        <a href="{{ url_for('fichajes.listar') }}" {% if 'fichajes.listar' in request.endpoint %}class="active" {% endif
            %}>
            <i class="bi bi-clock"></i> Mis Fichajes
        </a>
        <a href="{{ url_for('ausencias.listar_vacaciones') }}" {% if 'vacaciones' in request.endpoint %}class="active"
            {% endif %}>
            <i class="bi bi-calendar-check"></i> Mis Vacaciones
        </a>
        <a href="{{ url_for('ausencias.listar_bajas') }}" {% if 'bajas' in request.endpoint %}class="active" {% endif
            %}>
            <i class="bi bi-bandaid"></i> Mis Ausencias
        </a>
        <a href="{{ url_for('main.cronograma') }}" {% if request.endpoint=='main.cronograma' %}class="active" {% endif
            %}>
            <i class="bi bi-calendar3"></i> Cronograma
        </a>

        {% if current_user.rol in ['aprobador', 'admin'] %}
        <div class="text px-3 mt-3 mb-2 small" style="color: white;">APROBACIÓN</div>
        <a href="{{ url_for('ausencias.aprobar_solicitudes') }}" {% if request.endpoint=='ausencias.aprobar_solicitudes'
            %}class="active" {% endif %}>
            <i class="bi bi-check-circle"></i> Aprobar Solicitudes
        </a>
        {% endif %}

        {% if current_user.rol == 'admin' %}
        <div class="text px-3 mt-3 mb-2 small" style="color: white;">ADMINISTRACIÓN</div>
        <a href="{{ url_for('admin.admin_usuarios') }}" {% if 'admin_usuarios' in request.endpoint %}class="active" {%
            endif %}>
            <i class="bi bi-people"></i> Usuarios
        </a>
        <a href="{{ url_for('admin.admin_aprobadores') }}" {% if 'admin_aprobadores' in request.endpoint
            %}class="active" {% endif %}>
            <i class="bi bi-person-check"></i> Aprobadores
        </a>
        <a href="{{ url_for('admin.admin_tipos_ausencia') }}" {% if 'admin_tipos' in request.endpoint %}class="active"
            {% endif %}>
            <i class="bi bi-clipboard-pulse"></i> Tipos de Ausencia
        </a>
        <a href="{{ url_for('admin.admin_festivos') }}" {% if 'admin_festivos' in request.endpoint %}class="active" {%
            endif %}>
            <i class="bi bi-calendar-event"></i> Festivos
        </a>
        <a href="{{ url_for('admin.admin_fichajes') }}" {% if 'admin_fichajes' in request.endpoint %}class="active" {%
            endif %}>
            <i class="bi bi-clock-history"></i> Resumen Fichajes
        </a>
        <a href="{{ url_for('admin.admin_gestion_ausencias') }}" {% if 'gestion_ausencias' in request.endpoint
            %}class="active" {% endif %}>
            <i class="bi bi-calendar-range"></i> Resumen Ausencias
        </a>
        <a href="{{ url_for('admin.admin_resumen') }}" {% if request.endpoint=='admin.admin_resumen' %}class="active" {%
            endif %}>
            <i class="bi bi-file-earmark-bar-graph"></i> Días Restantes
        </a>
        <a href="{{ url_for('admin.admin_auditoria') }}" {% if request.endpoint=='admin.admin_auditoria'
            %}class="active" {% endif %}>
            <i class="bi bi-shield-check"></i> Auditoría Cambios
        </a>
        {% endif %}
    </div>
    {% endif %}

    <div class="{% if current_user.is_authenticated %}main-content{% else %}container mt-5{% endif %}">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages | unique %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
            role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Modal de Confirmación Global -->
    <div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Confirmar Acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" id="confirmModalClose"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    ¿Estás seguro de que deseas realizar esta acción?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        id="confirmModalCancel">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmModalAction">
                        <span id="confirmModalActionText">Confirmar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/export_csv.js') }}"></script>

    <!-- Helper global para modales de confirmación -->
    <script>
        /**
         * Muestra un modal de confirmación y ejecuta callback al confirmar
         * @param {string} title - Título del modal
         * @param {string} message - Mensaje del modal
         * @param {Function} onConfirm - Función async a ejecutar al confirmar
         * @param {string} variant - Variante de Bootstrap para el botón (primary, danger, warning, etc.)
         * @param {string} confirmText - Texto del botón de confirmación
         */
        async function showConfirmModal(title, message, onConfirm, variant = 'primary', confirmText = 'Confirmar') {
            const modalEl = document.getElementById('confirmModal');
            const modal = new bootstrap.Modal(modalEl);

            // Configurar contenido
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').textContent = message;
            document.getElementById('confirmModalActionText').textContent = confirmText;

            const actionBtn = document.getElementById('confirmModalAction');
            const cancelBtn = document.getElementById('confirmModalCancel');
            const closeBtn = document.getElementById('confirmModalClose');

            // Configurar variante del botón
            actionBtn.className = `btn btn-${variant}`;

            // Limpiar listeners previos clonando el botón
            const newActionBtn = actionBtn.cloneNode(true);
            actionBtn.parentNode.replaceChild(newActionBtn, actionBtn);

            // Añadir nuevo listener
            newActionBtn.addEventListener('click', async function () {
                // Deshabilitar todos los botones
                newActionBtn.disabled = true;
                cancelBtn.disabled = true;
                closeBtn.disabled = true;

                // Mostrar spinner
                const originalText = newActionBtn.querySelector('#confirmModalActionText').textContent;
                newActionBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';

                try {
                    await onConfirm();
                    modal.hide();
                } catch (error) {
                    console.error('Error en confirmación:', error);
                    // Re-habilitar botones en caso de error
                    newActionBtn.disabled = false;
                    cancelBtn.disabled = false;
                    closeBtn.disabled = false;
                    newActionBtn.innerHTML = `<span id="confirmModalActionText">${originalText}</span>`;
                    alert('Error: ' + (error.message || 'No se pudo completar la acción'));
                }
            });

            // Re-habilitar botones al cerrar el modal
            modalEl.addEventListener('hidden.bs.modal', function () {
                newActionBtn.disabled = false;
                cancelBtn.disabled = false;
                closeBtn.disabled = false;
                newActionBtn.innerHTML = `<span id="confirmModalActionText">${confirmText}</span>`;
            }, { once: true });

            modal.show();
        }

        /**
         * Helper para enviar formulario con confirmación
         * @param {HTMLFormElement} form - Formulario a enviar
         */
        function submitFormWithConfirm(form) {
            return new Promise((resolve, reject) => {
                // Crear FormData y enviar via fetch
                const formData = new FormData(form);

                fetch(form.action, {
                    method: form.method || 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrf_token')
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            // Redirigir o recargar según respuesta
                            if (response.redirected) {
                                window.location.href = response.url;
                            } else {
                                window.location.reload();
                            }
                            resolve();
                        } else {
                            reject(new Error('Error en la petición'));
                        }
                    })
                    .catch(error => reject(error));
            });
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>