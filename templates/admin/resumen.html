{% extends "base.html" %}

{% block title %}Resumen Global{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-file-earmark-bar-graph"></i> Resumen Global Anual</h1>

    <div>
        <button onclick="exportTableToCSV('resumen_global.csv', false)" class="btn btn-success me-2">
            <i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV
        </button>
    </div>
</div>

<div class="card mb-4 bg-light">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">Empleado</label>
                <input type="hidden" name="usuario_id" id="usuario_id_hidden"
                    value="{{ usuario_seleccionado.id if usuario_seleccionado else '' }}">
                <div class="position-relative">
                    <input type="text" id="usuario_search_input" class="form-control" placeholder="Buscar empleado..."
                        autocomplete="off"
                        value="{{ usuario_seleccionado.nombre + ' (' + usuario_seleccionado.email + ')' if usuario_seleccionado else '' }}">
                </div>
                <small class="text-muted">Escribe para buscar...</small>
            </div>

            <div class="col-md-3">
                <label class="form-label fw-bold">Año</label>
                <select name="anio" class="form-select" onchange="this.form.submit()">
                    {% for a in range(2023, 2026) %}
                    <option value="{{ a }}" {% if a==anio_actual %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <a href="{{ url_for('admin.admin_resumen') }}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-counterclockwise"></i> Resetear
                </a>
            </div>
        </form>
    </div>
</div>

<div class="alert alert-info d-flex justify-content-between align-items-center">
    <span>
        <i class="bi bi-info-circle"></i> Datos del año <strong>{{ anio_actual }}</strong>
    </span>
    <span class="fs-5">
        Pendientes de disfrutar global: <strong>{{ total_dias_restantes }} días</strong>
    </span>
</div>

{% if resumen_usuarios %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-table"></i> Tabla Detallada</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Usuario</th>
                        <th class="text-center">Días Totales</th>
                        <th class="text-center">Disfrutados</th>
                        <th class="text-center">Restantes</th>
                        <th style="width: 20%;">Estado Vacaciones</th>
                        <th class="text-end">Horas (Año {{ anio_actual }})</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in resumen_usuarios %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ item.usuario.nombre }}</div>
                            <small class="text-muted">{{ item.usuario.email }}</small>
                        </td>
                        <td class="text-center">{{ item.dias_vacaciones_totales }}</td>
                        <td class="text-center"><span class="badge bg-warning text-dark">{{ item.dias_disfrutados
                                }}</span></td>
                        <td class="text-center"><span class="badge bg-success">{{ item.dias_restantes }}</span></td>
                        <td>
                            {% set porcentaje = (item.dias_disfrutados / item.dias_vacaciones_totales * 100) if
                            item.dias_vacaciones_totales > 0 else 0 %}
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                    <div class="progress-bar {% if porcentaje > 80 %}bg-danger{% elif porcentaje > 50 %}bg-warning{% else %}bg-success{% endif %}"
                                        style="width: {{ porcentaje }}%"></div>
                                </div>
                                <small class="text-muted">{{ "%.0f"|format(porcentaje) }}%</small>
                            </div>
                        </td>
                        <td class="text-end fw-bold">{{ item.horas_totales | formato_hora }}h</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td class="fw-bold">TOTALES</td>
                        <td class="text-center fw-bold">{{ resumen_usuarios|sum(attribute='dias_vacaciones_totales') }}
                        </td>
                        <td class="text-center fw-bold">{{ total_dias_disfrutados }}</td>
                        <td class="text-center fw-bold text-success">{{ total_dias_restantes }}</td>
                        <td></td>
                        <td class="text-end fw-bold">{{ "%.2f"|format(resumen_usuarios|sum(attribute='horas_totales'))
                            }}h</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-warning text-center mt-4">
    <i class="bi bi-search"></i> No se encontraron usuarios con los filtros seleccionados.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/user_search.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        setupUserSearch('usuario_search_input', 'usuario_id_hidden', true);
    });
</script>
{% endblock %}